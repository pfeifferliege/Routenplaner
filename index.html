<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TomTom Tourenplanung - Final</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script> 
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Verhindert automatisches Zoomen bei Klick auf Inputs auf dem iPhone */
        input, select { font-size: 16px !important; }

        /* WICHTIG: Erlaubt echtes Scrollen innerhalb des Planers auf dem Smartphone */
        .calculator-scroll-area { 
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: scroll; 
            -webkit-overflow-scrolling: touch; 
            display: block;
        }

        /* Puffer unten, damit Buttons nicht vom mobilen Toggle-Button verdeckt werden */
        .action-area {
            padding-bottom: 250px; 
        }
        
        #map-display { width: 100%; height: 100%; z-index: 1; } 

        .tab-btn.active { background-color: white; border-top: 3px solid #1e40af; color: #1e40af; font-weight: 700; }
        .tab-btn:not(.active) { background-color: #e5e7eb; color: #6b7280; }
        
        .drag-handle { cursor: grab; padding: 12px; color: #9ca3af; touch-action: none; display: flex; align-items: center; }
        
        .editable-title {
            border-bottom: 2px dashed #cbd5e1;
            transition: all 0.2s;
        }
        .editable-title:focus {
            border-bottom-color: #3b82f6;
            outline: none;
            background-color: #f8fafc;
        }

        .mobile-view-transition { transition: transform 0.3s ease-in-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-f3f4f6">

    <div class="bg-white border-b border-gray-300 flex-none z-30 shadow-sm">
        <div class="w-full mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg font-extrabold text-gray-700">Tourenplanung</h1>
            <button onclick="addNewTab()" class="bg-blue-600 text-white font-bold py-1.5 px-3 rounded shadow text-sm transition active:scale-95">
                <i class="fas fa-plus mr-1"></i> Neu
            </button>
        </div>
    </div>

    <div class="flex-grow relative w-full overflow-hidden md:flex"> 
        <div id="list-panel" class="mobile-view-transition absolute inset-0 z-20 w-full h-full bg-white md:static md:w-1/2 md:border-r border-gray-300 flex flex-col">
            <div class="bg-gray-100 border-b border-gray-300 px-2 pt-2 flex-none">
                <div id="tabs-header" class="flex space-x-1 overflow-x-auto no-scrollbar"></div>
            </div>
            <div id="tabs-content" class="flex-grow relative"></div>
        </div>

        <div id="map-container" class="absolute inset-0 z-10 w-full h-full md:static md:w-1/2 bg-gray-200">
            <div id="map-display"></div>
        </div>

        <button id="mobileToggleBtn" onclick="toggleMobileView()" class="md:hidden fixed bottom-6 right-6 z-50 bg-blue-700 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center border-2 border-white">
            <i class="fas fa-map-marked-alt text-xl"></i>
        </button>
    </div>

    <datalist id="addressSuggestions"></datalist>

    <script>
        const TOMTOM_API_KEY = "SiBGVPRYbkR0dbKAMIrdoZYd4BDGkP9c"; 
        const BUFFER_MINUTES = 10;
        const INITIAL_START_TIME = "08:15";
        const DEFAULT_START_ADDRESS = "Michaelstein 18, 38889 Blankenburg"; 
        const STORAGE_KEY = "tourPlanner_savedAddresses";

        let currentMap = null;
        let routeLayer = null;  
        let markerLayers = [];  
        let tabCounter = 0;
        let isListView = true;

        // --- Adress-Vorschläge Logik ---
        function getSavedAddresses() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveAddressesToHistory(stops) {
            let history = getSavedAddresses();
            stops.forEach(s => {
                if (s.address && s.address.length > 5 && !history.includes(s.address)) {
                    history.push(s.address);
                }
            });
            if (history.length > 50) history = history.slice(-50);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            updateDatalist();
        }

        function updateDatalist() {
            const history = getSavedAddresses();
            document.getElementById('addressSuggestions').innerHTML = history.map(addr => `<option value="${addr}">`).join('');
        }

        function toggleMobileView() {
            const listPanel = document.getElementById('list-panel');
            const btn = document.getElementById('mobileToggleBtn');
            if (isListView) {
                listPanel.style.transform = "translateX(-100%)";
                btn.innerHTML = '<i class="fas fa-list-ul text-xl"></i>';
                isListView = false;
                setTimeout(() => { if(currentMap) currentMap.invalidateSize(); }, 350);
            } else {
                listPanel.style.transform = "translateX(0)";
                btn.innerHTML = '<i class="fas fa-map-marked-alt text-xl"></i>';
                isListView = true;
            }
        }

        function initMap() {
            if (currentMap) return;
            currentMap = L.map('map-display', { zoomControl: false }).setView([51.833, 10.790], 12);
            L.control.zoom({ position: 'topright' }).addTo(currentMap);
            L.tileLayer(`https://api.tomtom.com/map/1/tile/basic/main/{z}/{x}/{y}.png?key=${TOMTOM_API_KEY}`).addTo(currentMap);
        }

        const calculatorTemplate = `
            <div class="calculator-scroll-area px-4 pt-4">
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-blue-900 editable-title px-1 py-1 inline-block min-w-[100px]" contenteditable="true">Tour Name</h2>
                    <p class="text-[10px] text-gray-400">Klicken zum Umbenennen</p>
                </div>

                <div class="mb-4 p-4 bg-blue-50 rounded-xl border border-blue-200 shadow-sm">
                    <label class="block text-xs font-bold text-blue-800 uppercase mb-1">⏱️ Startzeit</label>
                    <select class="startTime w-full p-2 border border-blue-300 rounded-lg font-mono mb-2"></select>
                </div>
                
                <div class="stopsContainer space-y-2"></div>
                
                <div class="action-area mt-6 flex flex-col gap-3">
                    <button class="addBtn w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow active:scale-95"><i class="fas fa-plus mr-2"></i>Stopp dazu</button>
                    <button class="updateBtn w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow active:scale-95"><i class="fas fa-route mr-2"></i>Anzeigen & Berechnen</button>
                    
                    <div class="border-t border-gray-200 mt-4 pt-4">
                        <button class="resetBtn w-full py-3 bg-red-100 text-red-700 font-bold rounded-lg border border-red-200 active:bg-red-200">
                            <i class="fas fa-trash-alt mr-2"></i> Tour zurücksetzen (Reset)
                        </button>
                    </div>
                </div>
            </div>
        `;

        function addNewTab() {
            tabCounter++;
            const id = tabCounter;
            const tabBtn = document.createElement('div');
            tabBtn.id = `tab-btn-${id}`;
            tabBtn.className = `tab-btn cursor-pointer px-4 py-2 rounded-t-lg border border-gray-300 text-sm flex items-center shrink-0`;
            tabBtn.innerHTML = `<span class="tab-label mr-2">Tour ${id}</span><span class="px-1 hover:text-red-500 font-bold" onclick="this.parentElement.remove()">✕</span>`;
            
            tabBtn.onclick = (e) => { if(e.target.tagName !== 'SPAN' || !e.target.innerText.includes('✕')) switchTab(id); };
            
            const contentDiv = document.createElement('div');
            contentDiv.id = `tab-content-${id}`;
            contentDiv.className = 'hidden h-full w-full absolute inset-0'; 
            contentDiv.innerHTML = calculatorTemplate;

            const titleElem = contentDiv.querySelector('.editable-title');
            titleElem.innerText = `Tour ${id}`;
            titleElem.oninput = () => {
                const newTitle = titleElem.innerText.trim() || `Tour ${id}`;
                tabBtn.querySelector('.tab-label').innerText = newTitle;
            };

            document.getElementById('tabs-header').appendChild(tabBtn);
            document.getElementById('tabs-content').appendChild(contentDiv);
            initCalculatorInstance(contentDiv, id);
            switchTab(id);
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#tabs-content > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(`tab-btn-${id}`).classList.add('active');
            document.getElementById(`tab-content-${id}`).classList.remove('hidden');
        }

        function initCalculatorInstance(root, id) {
            let tourStops = [{address: DEFAULT_START_ADDRESS, drive:0}, {address:'', drive:0}, {address:'', drive:0}];
            const container = root.querySelector('.stopsContainer');
            const timeSelect = root.querySelector('.startTime');

            for(let h=0; h<24; h++) for(let m=0; m<60; m+=15) {
                const t=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                timeSelect.innerHTML += `<option value="${t}" ${t===INITIAL_START_TIME?'selected':''}>${t}</option>`;
            }

            // Drag and Drop Initialisierung
            new Sortable(container, {
                handle: '.drag-handle',
                animation: 200,
                onEnd: () => {
                    const newStops = [];
                    container.querySelectorAll('.stop-row').forEach(row => {
                        const idx = row.dataset.id;
                        newStops.push(tourStops[idx]);
                    });
                    tourStops = newStops;
                    render();
                }
            });

            function render() {
                container.innerHTML = '';
                tourStops.forEach((s, i) => {
                    const row = document.createElement('div');
                    row.className = 'stop-row flex items-center gap-2 p-2 bg-white border border-gray-200 rounded-lg shadow-sm';
                    row.dataset.id = i;
                    row.innerHTML = `
                        <div class="drag-handle"><i class="fas fa-bars"></i></div>
                        <div class="font-bold text-blue-600 w-5 text-sm">${i+1}.</div>
                        <input class="flex-grow p-2 border rounded text-sm min-w-0" value="${s.address || ''}" list="addressSuggestions" placeholder="Adresse eingeben...">
                        <div class="text-[11px] font-bold text-blue-800 w-10 text-center">${s.arrStr || '--:--'}</div>
                        <button class="text-gray-300 px-2 hover:text-red-500" onclick="this.parentElement.remove()">✕</button>
                    `;
                    row.querySelector('input').onchange = (e) => { s.address = e.target.value; };
                    container.appendChild(row);
                });
            }

            async function updateRoute() {
                const inputs = container.querySelectorAll('input');
                inputs.forEach((inp, idx) => { if(tourStops[idx]) tourStops[idx].address = inp.value; });
                
                saveAddressesToHistory(tourStops);
                const valid = tourStops.filter(s => s.address.length > 3);
                
                if (valid.length < 2) { alert("Bitte mindestens zwei Adressen eingeben."); return; }

                try {
                    const coords = [];
                    for(let s of valid) {
                        const res = await fetch(`https://api.tomtom.com/search/2/search/${encodeURIComponent(s.address)}.json?key=${TOMTOM_API_KEY}&limit=1`);
                        const data = await res.json();
                        const pos = data.results[0].position;
                        coords.push(pos);
                        s.lat = pos.lat; s.lon = pos.lon;
                    }

                    const locs = coords.map(c => `${c.lat},${c.lon}`).join(':');
                    const res = await fetch(`https://api.tomtom.com/routing/1/calculateRoute/${locs}/json?key=${TOMTOM_API_KEY}`);
                    const data = await res.json();
                    
                    const route = data.routes[0];
                    route.legs.forEach((leg, i) => {
                        if(tourStops[i+1]) tourStops[i+1].drive = Math.ceil(leg.summary.travelTimeInSeconds/60);
                    });

                    // Zeitberechnung
                    const startMins = parseInt(timeSelect.value.split(':')[0])*60 + parseInt(timeSelect.value.split(':')[1]);
                    let currentMins = startMins;
                    tourStops.forEach((s, i) => {
                        if(i > 0) {
                            currentMins += (s.drive || 0);
                            currentMins = Math.ceil(currentMins/5)*5;
                            s.arrStr = `${Math.floor(currentMins/60)%24}:${String(currentMins%60).padStart(2,'0')}`;
                            currentMins += BUFFER_MINUTES;
                        } else { s.arrStr = 'Start'; }
                    });

                    // Karte aktualisieren
                    if (routeLayer) currentMap.removeLayer(routeLayer);
                    markerLayers.forEach(m => currentMap.removeLayer(m));
                    markerLayers = [];

                    const points = [];
                    route.legs.forEach(l => l.points.forEach(p => points.push([p.latitude, p.longitude])));
                    routeLayer = L.polyline(points, {color: 'blue', weight: 5}).addTo(currentMap);
                    
                    tourStops.forEach((s, i) => {
                        if(s.lat) {
                            const m = L.marker([s.lat, s.lon]).addTo(currentMap).bindPopup(`${i+1}. ${s.address}`);
                            markerLayers.push(m);
                        }
                    });

                    currentMap.fitBounds(routeLayer.getBounds(), {padding: [30, 30]});
                    render();
                } catch(e) { alert("Fehler bei der Routenberechnung!"); }
            }

            root.querySelector('.addBtn').onclick = () => { tourStops.push({address:'', drive:0}); render(); };
            root.querySelector('.updateBtn').onclick = updateRoute;
            root.querySelector('.resetBtn').onclick = () => { 
                if(confirm('Möchtest du diese Tour wirklich zurücksetzen?')) { 
                    tourStops = [{address: DEFAULT_START_ADDRESS, drive:0}, {address:'', drive:0}, {address:'', drive:0}]; 
                    render(); 
                }
            };
            
            render();
        }

        updateDatalist();
        initMap(); 
        addNewTab();
    </script>
</body>
</html>
