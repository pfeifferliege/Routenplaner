<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TomTom Tourenplanung</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script> 
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        .calculator-scroll-area { 
            overflow-y: auto; 
            height: 100%; 
            padding-bottom: 2rem; 
            max-width: 900px; 
            margin: 0 auto; 
            background-color: white; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); 
        }
        
        /* Map Container Style */
        #map-display { width: 100%; height: 100%; z-index: 1; } 
        
        /* Custom Marker Style */
        .custom-div-icon { 
            background-color: transparent;
            border: none;
            text-align: center;
        }

        .calculator-scroll-area::-webkit-scrollbar { width: 8px; }
        .calculator-scroll-area::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        .tab-btn.active { background-color: white; border-top: 3px solid #1e40af; border-bottom-color: transparent; color: #1e40af; font-weight: 700; }
        .tab-btn:not(.active) { background-color: #e5e7eb; color: #6b7280; border-bottom: 1px solid #d1d5db; }
        
        .drag-handle { cursor: grab; padding: 0.5rem; }
        .ghost { opacity: 0.5; background: #fefcbf; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-f3f4f6">

    <div class="bg-white border-b border-gray-300 flex-none z-20 shadow-sm sticky top-0">
        <div class="w-full mx-auto px-4 pt-4 pb-2"> 
            <div class="flex justify-between items-end">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl md:text-2xl font-extrabold text-gray-700">Tourenplanung</h1>
                    <span class="text-xs text-gray-400 hidden md:inline-block">| TomTom API Integration</span>
                </div>
                <button onclick="addNewTab()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded shadow flex items-center text-sm transition hover:scale-105">
                    Neue Tour
                </button>
            </div>
        </div>
    </div>

    <div class="flex-grow flex h-full overflow-hidden w-full"> 
        
        <div class="flex flex-col h-full overflow-hidden w-1/2 border-r border-gray-300">
            <div class="bg-gray-100 border-b border-gray-300 px-4 pt-2 flex-none">
                <div id="tabs-header" class="flex space-x-1 overflow-x-auto pb-0.5 no-scrollbar"></div>
            </div>
            <div id="tabs-content" class="flex-grow relative overflow-hidden"></div>
        </div>

        <div id="map-container" class="w-1/2 h-full relative">
            <div id="map-display"></div>
        </div>
    </div>

    <datalist id="addressSuggestions"></datalist>

    <script>
        // ====================================================================
        // KONFIGURATION
        // ====================================================================
        const TOMTOM_API_KEY = "SiBGVPRYbkR0dbKAMIrdoZYd4BDGkP9c"; 
        const BUFFER_MINUTES = 10;
        const INITIAL_START_TIME = "08:15";
        const DEFAULT_START_ADDRESS = "Michaelstein 18, 38889 Blankenburg"; 

        // Globale Variablen
        let currentMap = null;
        let routeLayer = null;  
        let markerLayers = [];  
        let instanceData = []; 
        let tabCounter = 0;
        let activeTabId = null;

        // ====================================================================
        // KARTEN-LOGIK
        // ====================================================================

        function initMap() {
            if (!document.getElementById('map-display')) return;
            currentMap = L.map('map-display').setView([51.833, 10.790], 12);
            L.tileLayer(`https://api.tomtom.com/map/1/tile/basic/main/{z}/{x}/{y}.png?key=${TOMTOM_API_KEY}`, {
                attribution: '¬© TomTom',
                maxZoom: 19
            }).addTo(currentMap);
        }

        function drawRouteOnMap(routePoints, stops) {
            if (!currentMap) initMap();

            if (routeLayer) currentMap.removeLayer(routeLayer);
            markerLayers.forEach(m => currentMap.removeLayer(m));
            markerLayers = [];

            if (routePoints && routePoints.length > 0) {
                routeLayer = L.polyline(routePoints, { color: 'blue', weight: 5 }).addTo(currentMap);
                currentMap.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
            }

            stops.forEach((stop, index) => {
                if (stop.lat && stop.lon) {
                    const iconHtml = `<div style="background-color: ${index === 0 ? '#10b981' : '#3b82f6'}; color: white; border-radius: 50%; width: 24px; height: 24px; text-align: center; font-weight: bold; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);">${index + 1}</div>`;
                    
                    // Zeigt nun Ankunfts- und Abfahrtszeit im Popup
                    const popupContent = `<b>${index+1}. ${stop.address}</b><br>Ankunft: ${stop.arrStr}<br>Abfahrt: ${stop.depStr}`;

                    const marker = L.marker([stop.lat, stop.lon], {
                        icon: L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [24, 24], iconAnchor: [12, 12] })
                    }).addTo(currentMap).bindPopup(popupContent);
                    
                    markerLayers.push(marker);
                }
            });
            
            setTimeout(() => { currentMap.invalidateSize(); }, 200);
        }

        // ====================================================================
        // HELPER
        // ====================================================================
        const ADDRESS_STORAGE_KEY = "tomtomSavedAddresses";
        let savedAddresses = [];

        function loadAddresses() {
            try {
                const json = localStorage.getItem(ADDRESS_STORAGE_KEY);
                savedAddresses = json ? JSON.parse(json) : [];
                updateDatalist();
            } catch (e) { console.error(e); }
        }

        function saveAddress(address) {
            if (!address || address.trim() === "") return;
            const trimmed = address.trim();
            savedAddresses = savedAddresses.filter(a => a !== trimmed);
            savedAddresses.unshift(trimmed);
            if (savedAddresses.length > 50) savedAddresses.pop();
            localStorage.setItem(ADDRESS_STORAGE_KEY, JSON.stringify(savedAddresses));
            updateDatalist();
        }

        function updateDatalist() {
            const dl = document.getElementById('addressSuggestions');
            if (dl) dl.innerHTML = savedAddresses.map(a => `<option value="${a}"></option>`).join('');
        }
        
        // Formatiert Minuten in H:MM (z.B. 70 -> 1:10)
        function formatTimeDuration(totalMinutes) {
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            return `${h}:${String(m).padStart(2, '0')}`;
        }

        loadAddresses();

        // ====================================================================
        // APP LOGIK
        // ====================================================================

        const calculatorTemplate = `
            <div class="calculator-scroll-area px-4 py-6">
                <div class="mb-4">
                    <h2 class="text-2xl font-extrabold text-blue-800 tour-title editable-title" contenteditable="true">Tour-Name</h2>
                </div>
                
                <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200 shadow-sm">                        
                    <div class="grid grid-cols-1 gap-4">                                
                        <div>
                            <label class="block text-sm font-bold text-blue-800 mb-1">‚è±Ô∏è Startzeit</label>
                            <select class="startTime w-full p-2 border border-blue-400 bg-white rounded-lg text-xl font-mono shadow-inner"></select>
                        </div>
                        <div class="pt-2 border-t border-blue-200">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Reine Fahrzeit / Strecke:</span>
                                <span class="totalDrivingTime font-extrabold text-blue-700">0:00 h / 0 km</span>
                            </div>                                                
                            <div class="flex justify-between items-center text-sm mt-1">
                                <span class="text-gray-600">Gesamtdauer (inkl. Puffer):</span>
                                <span class="totalTourDuration font-extrabold text-blue-700">0:00 h</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-2">üìç Stopps</h2>
                    <div id="status-message" class="p-3 mb-4 text-sm rounded-lg text-yellow-800 bg-yellow-50">Bitte Adressen eingeben.</div>
                    
                    <div class="flex items-center gap-2 p-2 text-xs font-bold text-gray-500 uppercase">
                        <div class="w-6 text-center">#</div>
                        <div class="flex-grow">Adresse</div>
                        <div class="w-20 text-center text-red-600">Fahrt / Km</div>
                        <div class="w-12 text-center text-blue-700">Ank. / Abf.</div> 
                        <div class="w-6"></div>
                    </div>

                    <div class="stopsContainer space-y-1 mt-1"></div>
                    
                    <div class="mt-6 flex flex-col gap-2 pt-4 border-t">
                        <button class="addStopButton w-full px-4 py-2 bg-green-600 text-white font-semibold rounded shadow hover:bg-green-700 transition text-sm">+ Stopp</button>
                        <button class="optimizeButton w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded shadow hover:bg-blue-700 transition text-sm">Route Optimieren (TomTom)</button>
                        <button class="resetButton w-full px-4 py-2 bg-red-100 text-red-600 font-semibold rounded shadow hover:bg-red-200 transition text-sm">Reset</button>
                    </div>                    
                </div>
                <p class="text-[10px] text-gray-400 text-center">*Puffer: ${BUFFER_MINUTES} Min</p>
            </div>
        `;

        function addNewTab() {
            tabCounter++;
            const currentId = tabCounter;
            
            const tabBtn = document.createElement('div');
            tabBtn.className = `tab-btn cursor-pointer px-3 py-2 rounded-t-lg border border-b-0 border-gray-300 flex items-center justify-between gap-2 select-none text-sm`;
            tabBtn.id = `tab-btn-${currentId}`;
            tabBtn.innerHTML = `<span class="tab-title truncate w-20">Tour ${currentId}</span><button onclick="closeTab(${currentId}, event)" class="text-gray-400 hover:text-red-500 rounded-full">‚úï</button>`;
            tabBtn.onclick = (e) => { if(!e.target.closest('button')) switchTab(currentId); };
            
            const contentDiv = document.createElement('div');
            contentDiv.id = `tab-content-${currentId}`;
            contentDiv.className = 'hidden h-full w-full absolute inset-0'; 
            contentDiv.innerHTML = calculatorTemplate;

            contentDiv.querySelector('.tour-title').addEventListener('input', function() {
                tabBtn.querySelector('.tab-title').textContent = this.textContent.trim() || '...';
            });

            document.getElementById('tabs-header').appendChild(tabBtn);
            document.getElementById('tabs-content').appendChild(contentDiv);
            
            const instance = initCalculatorInstance(contentDiv, currentId);
            instanceData.push(instance);
            switchTab(currentId);
        }

        function switchTab(id) {
            activeTabId = id;
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.classList.add('bg-gray-100'); });
            document.querySelectorAll('#tabs-content > div').forEach(d => d.classList.add('hidden'));
            
            const btn = document.getElementById(`tab-btn-${id}`);
            const content = document.getElementById(`tab-content-${id}`);
            
            if(btn) { btn.classList.add('active'); btn.classList.remove('bg-gray-100'); }
            if(content) content.classList.remove('hidden');

            const instance = instanceData.find(i => i.id === id);
            if (instance && instance.lastRoutePoints) {
                drawRouteOnMap(instance.lastRoutePoints, instance.tourStops);
            } else {
                 if(currentMap) {
                     if(routeLayer) currentMap.removeLayer(routeLayer);
                     markerLayers.forEach(m => currentMap.removeLayer(m));
                 }
            }
            if(currentMap) setTimeout(() => currentMap.invalidateSize(), 100);
        }

        function closeTab(id, event) {
            event.stopPropagation();
            if(!confirm("L√∂schen?")) return;
            const idx = instanceData.findIndex(i => i.id === id);
            if(idx > -1) instanceData.splice(idx, 1);
            
            document.getElementById(`tab-btn-${id}`).remove();
            document.getElementById(`tab-content-${id}`).remove();
            
            const tabs = document.querySelectorAll('.tab-btn');
            if(tabs.length > 0) {
                const lastId = parseInt(tabs[tabs.length-1].id.replace('tab-btn-',''));
                switchTab(lastId);
            } else {
                addNewTab();
            }
        }

        // ====================================================================
        // CALCULATOR INSTANZ
        // ====================================================================
        function initCalculatorInstance(root, id) {
            // *** HIER WURDE DIE ANZAHL DER STANDARD-STOPPS AUF 4 ERH√ñHT ***
            let tourStops = [
                {address: DEFAULT_START_ADDRESS, drive:0, dist:0, arrMins:0, depMins:0, arrStr:'---', depStr:'---', lat:null, lon:null}, 
                {address:'', drive:0, dist:0, arrMins:0, depMins:0, arrStr:'---', depStr:'---', lat:null, lon:null},
                {address:'', drive:0, dist:0, arrMins:0, depMins:0, arrStr:'---', depStr:'---', lat:null, lon:null},
                {address:'', drive:0, dist:0, arrMins:0, depMins:0, arrStr:'---', depStr:'---', lat:null, lon:null}
            ];
            
            let lastRoutePoints = null;

            const container = root.querySelector('.stopsContainer');
            const timeSelect = root.querySelector('.startTime');
            const statusMsg = root.querySelector('#status-message');
            const optBtn = root.querySelector('.optimizeButton');

            root.querySelector('.addStopButton').onclick = () => {
                tourStops.push({address:'', drive:0, dist:0, arrMins:0, depMins:0, arrStr:'---', depStr:'---', lat:null, lon:null});
                calculateTimes();
            };
            root.querySelector('.resetButton').onclick = () => {
                tourStops = [
                    {address: DEFAULT_START_ADDRESS, drive:0, dist:0, arrMins:0, depMins:0, lat:null, lon:null}, 
                    {address:'', drive:0, dist:0, arrMins:0, depMins:0, lat:null, lon:null}
                ];
                lastRoutePoints = null;
                calculateTimes();
            };
            optBtn.onclick = optimizeRoute;
            timeSelect.onchange = calculateTimes;

            for(let h=0;h<24;h++) for(let m=0;m<60;m+=15) {
                const t=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                const op=document.createElement('option'); op.value=t; op.textContent=t;
                if(t===INITIAL_START_TIME) op.selected=true;
                timeSelect.appendChild(op);
            }
            
            function updateStatus(msg, type) {
                statusMsg.textContent = msg;
                statusMsg.className = `p-3 mb-4 text-sm rounded-lg ${type==='error'?'text-red-800 bg-red-50':'text-green-800 bg-green-50'}`;
            }

            function calculateTimes() {
                const startMins = parseInt(timeSelect.value.split(':')[0])*60 + parseInt(timeSelect.value.split(':')[1]);
                let totalDrive = 0;
                let totalDist = 0;

                tourStops.forEach((s, i) => {
                    let arrival = 0;
                    
                    if(i===0) {
                        // 1. Startstopp: Ankunft ist "---", Abfahrt ist die gew√§hlte Startzeit
                        arrival = startMins;
                        s.arrMins = startMins; 
                        s.depMins = startMins; 
                    } else {
                        const prevStop = tourStops[i-1];
                        // 2. Ankunft = Abfahrt des vorherigen Stopps + Fahrzeit zum aktuellen Stopp
                        arrival = prevStop.depMins + (s.drive || 0); 
                        arrival = Math.ceil(arrival/5)*5; // Aufrunden auf 5-Minuten-Schritte
                        s.arrMins = arrival;
                        
                        // 3. Abfahrt = Ankunft + Servicezeit (BUFFER_MINUTES)
                        s.depMins = s.arrMins + BUFFER_MINUTES;
                    }
                    
                    // Formatierung der Ankunftszeit
                    const hArr = Math.floor(s.arrMins/60)%24;
                    const mArr = s.arrMins%60;
                    // Der Startstopp zeigt keine sinnvolle Ankunftszeit an
                    s.arrStr = i===0 ? '---' : `${String(hArr).padStart(2,'0')}:${String(mArr).padStart(2,'0')}`;

                    // Formatierung der Abfahrtszeit
                    const hDep = Math.floor(s.depMins/60)%24;
                    const mDep = s.depMins%60;
                    s.depStr = `${String(hDep).padStart(2,'0')}:${String(mDep).padStart(2,'0')}`;
                    
                    totalDrive += (s.drive || 0);
                    totalDist += (Number(s.dist) || 0);
                });

                render();
                
                // Berechnung der Gesamtdauer basierend auf der Abfahrtszeit des LETZTEN Stopps
                const last = tourStops[tourStops.length-1];
                const dur = last.depMins - startMins;
                
                // Formatiere die Gesamtsummen ebenfalls in H:MM
                const totalDriveStr = formatTimeDuration(totalDrive);
                const totalDurStr = formatTimeDuration(dur);

                root.querySelector('.totalDrivingTime').textContent = `${totalDriveStr} h / ${totalDist.toFixed(1)} km`;
                root.querySelector('.totalTourDuration').textContent = `${totalDurStr} h`;
            }

            function render() {
                updateDatalist();
                container.innerHTML = '';
                tourStops.forEach((s, i) => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center gap-2 p-2 bg-white border rounded shadow-sm';
                    
                    // Anzeige von Fahrtzeit (H:MM) UND Distanz
                    let driveInfo = '-';
                    if (i > 0) {
                        const timeStr = formatTimeDuration(s.drive);
                        driveInfo = `<span class="block">${timeStr} h</span>`;
                        if (s.dist) {
                            driveInfo += `<span class="block text-[10px] text-gray-500">(${s.dist} km)</span>`;
                        }
                    }

                    row.innerHTML = `
                        <div class="drag-handle text-gray-400 cursor-grab">‚ò∞</div>
                        <div class="font-bold text-blue-600 w-6 text-center">${i+1}.</div>
                        <input class="inp-addr flex-grow p-1 border rounded text-sm min-w-0" value="${s.address}" list="addressSuggestions" placeholder="Adresse">
                        <div class="text-xs font-bold text-red-500 w-20 text-center leading-tight">${driveInfo}</div>
                        <div class="text-xs font-bold w-12 text-center leading-tight">
                            <span class="text-blue-800 block">${s.arrStr}</span>
                            <span class="text-gray-500 block">${s.depStr}</span>
                        </div>
                        <button class="btn-del text-gray-400 hover:text-red-600 w-6">üóë</button>
                    `;
                    
                    row.querySelector('.inp-addr').onchange = (e) => { s.address = e.target.value; s.lat=null; };
                    row.querySelector('.btn-del').onclick = () => { 
                        if(tourStops.length > 1) { tourStops.splice(i, 1); calculateTimes(); }
                    };
                    container.appendChild(row);
                });
                
                new Sortable(container, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: (evt) => {
                        const item = tourStops.splice(evt.oldIndex, 1)[0];
                        tourStops.splice(evt.newIndex, 0, item);
                        
                        calculateTimes(); 
                        
                        if(activeTabId === id) {
                            drawRouteOnMap(lastRoutePoints, tourStops);
                        }
                    }
                });
            }

            // === TOMTOM API LOGIC ===
            async function getCoords(addr) {
                const res = await fetch(`https://api.tomtom.com/search/2/search/${encodeURIComponent(addr)}.json?key=${TOMTOM_API_KEY}&limit=1&countrySet=DE`);
                const data = await res.json();
                return data.results[0].position;
            }

            async function optimizeRoute() {
                const valid = tourStops.filter(s => s.address.trim().length > 3);
                if(valid.length < 2) return updateStatus("Zu wenig Adressen", 'error');
                
                optBtn.disabled = true;
                updateStatus("Berechne...", 'info');
                
                try {
                    for(let s of valid) {
                        if(!s.lat) {
                            const pos = await getCoords(s.address);
                            s.lat = pos.lat; s.lon = pos.lon;
                        }
                    }

                    const locs = valid.map(s => `${s.lat},${s.lon}`).join(':');
                    const url = `https://api.tomtom.com/routing/1/calculateRoute/${locs}/json?key=${TOMTOM_API_KEY}&computeBestOrder=true&routeRepresentation=polyline&traffic=false`;
                    
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if(!data.routes) throw new Error("Keine Route");

                    const route = data.routes[0];
                    
                    if(data.optimizedWaypoints) {
                        const start = valid[0];
                        const others = valid.slice(1);
                        const newOrder = [start];
                        data.optimizedWaypoints.forEach(wp => {
                            newOrder.push(others[wp.waypointIndex]);
                        });
                        
                        if(newOrder.length === valid.length) {
                             tourStops = newOrder; 
                        }
                    }

                    // Fahrzeiten UND Distanzen eintragen
                    for(let i=0; i<route.legs.length; i++) {
                        if(tourStops[i+1]) {
                            const legSummary = route.legs[i].summary;
                            tourStops[i+1].drive = Math.ceil(legSummary.travelTimeInSeconds/60);
                            tourStops[i+1].dist = (legSummary.lengthInMeters / 1000).toFixed(1);
                            saveAddress(tourStops[i+1].address);
                        }
                    }
                    saveAddress(tourStops[0].address);

                    const allPoints = [];
                    route.legs.forEach(leg => {
                        leg.points.forEach(p => allPoints.push([p.latitude, p.longitude]));
                    });
                    
                    lastRoutePoints = allPoints;
                    drawRouteOnMap(allPoints, tourStops);

                    calculateTimes();
                    updateStatus("Fertig!", 'success');

                } catch(e) {
                    console.error(e);
                    updateStatus("Fehler: " + e.message, 'error');
                } finally {
                    optBtn.disabled = false;
                }
            }

            calculateTimes();
            
            return {
                id,
                get tourStops() { return tourStops; },
                get lastRoutePoints() { return lastRoutePoints; }
            };
        }

        initMap(); 
        addNewTab();
    </script>
</body>
</html>
